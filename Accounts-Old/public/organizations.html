<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizations - Blacklink Accounts</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Modular CSS (v3.9) -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/nav.css">
  <style>
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-light: #a5b4fc;
      --bg: #0a0f1e;
      --bg-secondary: #1a1f35;
      --card-bg: #1a1f35;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #2d3548;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --ultra: #fbbf24;
      --ultra-plus: #f59e0b;
      --radius: 20px;
      --radius-sm: 12px;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 24px 48px rgba(0, 0, 0, 0.5), 0 12px 24px rgba(0, 0, 0, 0.4);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-top: 80px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-description {
      color: var(--text-secondary);
      font-size: 1.125rem;
    }

    .actions-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .admin-panel {
      margin-bottom: 2rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      border-radius: var(--radius-sm);
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 2rem;
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .org-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .admin-org-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .admin-org-chip {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.85rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      cursor: pointer;
      transition: var(--transition);
    }
    .admin-org-chip:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .admin-org-chip.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.15);
    }
    .admin-org-meta {
      display: flex;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .admin-config-panel {
      margin-top: 1.5rem;
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
    }
    .admin-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .hidden {
      display: none !important;
    }

    .org-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 2px solid var(--border);
      transition: var(--transition);
      cursor: pointer;
    }

    .org-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .org-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      margin-bottom: 1rem;
    }

    .org-name {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .org-meta {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .org-meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-owner {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .badge-admin {
      background: rgba(99, 102, 241, 0.15);
      color: var(--primary-light);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .badge-member {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .members-list {
      list-style: none;
      padding: 0;
    }

    .member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      margin-bottom: 0.75rem;
      transition: var(--transition);
    }

    .member-item:hover {
      border-color: var(--primary);
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.125rem;
    }

    .member-details h4 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .member-details p {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .member-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      border: 2px solid var(--border);
      box-shadow: var(--shadow-lg);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.875rem 1rem;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 1.5rem;
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .page-title {
        font-size: 2rem;
      }

      .org-grid {
        grid-template-columns: 1fr;
      }

      .actions-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <div id="navbar-container"></div>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title"><i class="fas fa-building"></i> Organizations</h1>
      <p class="page-description">Manage your teams, collaborate with members, and share resources across your organization.</p>
    </div>

    <div class="actions-bar">
      <div>
        <span id="org-count" style="color: var(--text-secondary);">Loading...</span>
      </div>
      <button class="btn" onclick="openCreateOrgModal()">
        <i class="fas fa-plus"></i>
        Create Organization
      </button>
    </div>

    <div class="card admin-panel">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-shield-alt"></i>
          Admin Organizations
        </div>
        <p class="text-muted" style="margin: 0;">Manage org settings when you're an admin or owner.</p>
      </div>
      <div id="admin-org-list" class="admin-org-list">
        <div class="empty-state">
          <i class="fas fa-user-lock"></i>
          <h3>No admin access detected</h3>
          <p>Join an organization as an admin or owner to unlock configuration tools.</p>
        </div>
      </div>
      <div id="admin-config-panel" class="admin-config-panel hidden">
        <h3 style="display:flex; align-items:center; gap:0.5rem;">
          <i class="fas fa-sliders-h"></i>
          <span id="admin-config-title">Organization Configuration</span>
        </h3>
        <form id="admin-config-form" onsubmit="saveAdminOrgConfig(event)">
          <div class="admin-config-grid">
            <div class="form-group">
              <label for="admin-config-name">Organization Name</label>
              <input type="text" id="admin-config-name" required>
            </div>
            <div class="form-group">
              <label for="admin-config-tier">Tier</label>
              <select id="admin-config-tier">
                <option value="FREE">Free</option>
                <option value="ULTRA">ULTRA</option>
                <option value="ULTRA_PLUS">ULTRA+</option>
              </select>
            </div>
            <div class="form-group">
              <label for="admin-config-credits">Shared Credits</label>
              <input type="number" id="admin-config-credits" min="0" step="1">
            </div>
          </div>
          <div class="form-group" style="margin-top:1rem;">
            <label for="admin-config-description">Description</label>
            <textarea id="admin-config-description" rows="3" placeholder="Describe this organization"></textarea>
          </div>
          <div class="flex gap-md" style="margin-top:1.5rem;">
            <button type="submit" class="btn" id="admin-config-save-btn">
              <i class="fas fa-save"></i>
              Save Changes
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetAdminConfigPanel()">
              <i class="fas fa-undo"></i>
              Reset
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="organizations-container">
      <div class="empty-state">
        <i class="fas fa-circle-notch fa-spin"></i>
        <h3>Loading organizations...</h3>
      </div>
    </div>
  </div>

  <!-- Create Organization Modal -->
  <div id="create-org-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Organization</h2>
        <button class="close-btn" onclick="closeCreateOrgModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="create-org-form" onsubmit="createOrganization(event)">
        <div class="form-group">
          <label for="org-name">Organization Name *</label>
          <input type="text" id="org-name" placeholder="Acme Corporation" required>
        </div>
        <div class="form-group">
          <label for="org-description">Description</label>
          <textarea id="org-description" placeholder="What does your organization do?"></textarea>
        </div>
        <div class="form-group">
          <label for="org-type">Organization Type *</label>
          <select id="org-type" required>
            <option value="">Select type...</option>
            <option value="business">Business</option>
            <option value="education">Education</option>
            <option value="nonprofit">Non-Profit</option>
            <option value="government">Government</option>
            <option value="other">Other</option>
          </select>
        </div>
        <button type="submit" class="btn" style="width: 100%;">
          <i class="fas fa-check"></i>
          Create Organization
        </button>
      </form>
    </div>
  </div>

  <!-- View Organization Modal -->
  <div id="view-org-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="view-org-title">Organization</h2>
        <button class="close-btn" onclick="closeViewOrgModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="org-member-count">0</div>
          <div class="stat-label">Members</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="org-credits">0</div>
          <div class="stat-label">Shared Credits</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="org-tier">FREE</div>
          <div class="stat-label">Plan</div>
        </div>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-users"></i> Members
        </h3>
        <ul class="members-list" id="org-members-list">
          <li class="member-item">
            <div class="empty-state">
              <i class="fas fa-circle-notch fa-spin"></i>
              <p>Loading members...</p>
            </div>
          </li>
        </ul>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button class="btn" onclick="openInviteMemberModal()" style="flex: 1;">
          <i class="fas fa-user-plus"></i>
          Invite Member
        </button>
        <button class="btn btn-danger" onclick="leaveOrganization()" style="flex: 1;">
          <i class="fas fa-sign-out-alt"></i>
          Leave Org
        </button>
      </div>
    </div>
  </div>

  <script src="js/navbar.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDh1cCQXw1TGVJdVVgLEGdOgZlTPzGORLw",
      authDomain: "blacklink-auth.firebaseapp.com",
      databaseURL: "https://blacklink-auth-default-rtdb.firebaseio.com",
      projectId: "blacklink-auth",
      storageBucket: "blacklink-auth.firebasestorage.app",
      messagingSenderId: "457832218084",
      appId: "1:457832218084:web:97ed6014a2ba6a6d789bf1",
      measurementId: "G-YXBK4L3VPL"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    let currentUser = null;
    let currentOrgId = null;
    let orgPermissionsBlocked = false;
    let adminOrganizations = [];
    let selectedAdminOrgId = null;
    const PERMISSION_DENIED = 'permission-denied';

    BlacklinkUtils.initTheme();
    Navbar.initNavbar(auth, db, 'organizations');

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '/login.html';
        return;
      }

      currentUser = user;

      if (window.BlacklinkAnalytics) {
        BlacklinkAnalytics.init(db, user);
        BlacklinkAnalytics.trackPageView('organizations');
      }

      loadOrganizations();
    });

    function renderPermissionWarning() {
      const container = document.getElementById('organizations-container');
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-lock"></i>
          <h3>Organizations are protected</h3>
          <p>Firestore security rules only allow staff or existing members to view organizations. Sign in with a staff account or update <code>rules.firestore</code> for testing.</p>
        </div>
      `;
      renderAdminOrganizations(true);
      BlacklinkUtils.showToast('Organizations require elevated Firestore access.', 'warning');
    }

    function renderAdminOrganizations(forceLocked = false) {
      const listEl = document.getElementById('admin-org-list');
      const configPanel = document.getElementById('admin-config-panel');
      if (!listEl || !configPanel) return;

      if (selectedAdminOrgId && !adminOrganizations.some((org) => org.id === selectedAdminOrgId)) {
        selectedAdminOrgId = null;
      }

      if (forceLocked || orgPermissionsBlocked) {
        listEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-lock"></i>
            <h3>Admin tools locked</h3>
            <p>Your account needs staff or org-admin permissions to manage organizations.</p>
          </div>
        `;
        configPanel.classList.add('hidden');
        return;
      }

      if (!adminOrganizations.length) {
        listEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>No admin access detected</h3>
            <p>Join an organization as an admin or owner to unlock configuration tools.</p>
          </div>
        `;
        configPanel.classList.add('hidden');
        selectedAdminOrgId = null;
        return;
      }

      listEl.innerHTML = adminOrganizations.map((org) => `
        <button type="button"
          class="admin-org-chip ${selectedAdminOrgId === org.id ? 'active' : ''}"
          onclick="selectAdminOrg('${org.id}')">
          <div>
            <strong>${org.name}</strong>
            <div class="admin-org-meta">
              <span>${(org.role || 'member').toUpperCase()}</span>
              <span>${org.memberCount || 1} members</span>
            </div>
          </div>
          <i class="fas fa-chevron-right"></i>
        </button>
      `).join('');

      if (!selectedAdminOrgId) {
        configPanel.classList.add('hidden');
      }
    }

    function getRolePriority(role) {
      switch ((role || 'member').toLowerCase()) {
        case 'owner':
          return 3;
        case 'admin':
          return 2;
        default:
          return 1;
      }
    }

    async function loadOrganizations() {
      const container = document.getElementById('organizations-container');
      const countEl = document.getElementById('org-count');

      if (orgPermissionsBlocked) {
        renderPermissionWarning();
        countEl.textContent = '0 organizations';
        return;
      }

      try {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-circle-notch fa-spin"></i>
            <h3>Loading organizations...</h3>
          </div>
        `;

        const orgCollection = db.collection('organizations');

        const [ownedSnapshot, memberSnapshot] = await Promise.all([
          orgCollection.where('owner', '==', currentUser.uid).get(),
          db.collectionGroup('members')
            .where('email', '==', currentUser.email || '')
            .get().catch(() => ({ empty: true, docs: [] }))
        ]);

        const orgMap = new Map();

        ownedSnapshot.forEach((docSnap) => {
          orgMap.set(docSnap.id, {
            id: docSnap.id,
            data: docSnap.data(),
            role: 'owner'
          });
        });

        const memberDocFetches = [];

        memberSnapshot.docs.forEach((memberSnap) => {
          const memberData = memberSnap.data();
          const orgRef = memberSnap.ref.parent.parent;
          if (!orgRef) return;
          const orgId = orgRef.id;
          const role = memberData.role || 'member';

          if (orgMap.has(orgId)) {
            const current = orgMap.get(orgId);
            if (getRolePriority(role) > getRolePriority(current.role)) {
              current.role = role;
            }
            return;
          }

          orgMap.set(orgId, {
            id: orgId,
            role,
            ref: orgRef
          });
          memberDocFetches.push(orgRef.get().then((docSnap) => ({
            id: orgId,
            docSnap
          })));
        });

        if (memberDocFetches.length) {
          const memberDocs = await Promise.all(memberDocFetches);
          memberDocs.forEach(({ id, docSnap }) => {
            if (!docSnap.exists) return;
            const entry = orgMap.get(id);
            if (entry) {
              entry.data = docSnap.data();
            }
          });
        }

        const userOrgs = Array.from(orgMap.values())
          .filter(entry => entry.data)
          .map(entry => ({
            id: entry.id,
            ...entry.data,
            role: entry.role || 'member'
          }));

        countEl.textContent = `${userOrgs.length} organization${userOrgs.length === 1 ? '' : 's'}`;

        if (userOrgs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-building"></i>
              <h3>No Organizations Yet</h3>
              <p>Create your first organization to start collaborating with your team.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="org-grid">
            ${userOrgs.map(org => `
              <div class="org-card" onclick="viewOrganization('${org.id}')">
                <div class="org-icon">
                  <i class="fas fa-${org.type === 'education'
                    ? 'graduation-cap'
                    : org.type === 'nonprofit'
                      ? 'hand-holding-heart'
                      : org.type === 'government'
                        ? 'landmark'
                        : 'building'}"></i>
                </div>
                <div class="org-name">${org.name}</div>
                <span class="badge badge-${org.role}">${org.role}</span>
                <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.875rem;">${org.description || 'No description'}</p>
                <div class="org-meta">
                  <div class="org-meta-item">
                    <i class="fas fa-users"></i>
                    <span>${org.memberCount || 1} members</span>
                  </div>
                  <div class="org-meta-item">
                    <i class="fas fa-coins"></i>
                    <span>${org.sharedCredits || 0} credits</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        adminOrganizations = userOrgs.filter((org) => {
          const role = (org.role || '').toLowerCase();
          return role === 'admin' || role === 'owner';
        });
        renderAdminOrganizations();

        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('organizations_loaded', {
            total: userOrgs.length
          });
        }
      } catch (error) {
        console.error('Error loading organizations:', error);
        if (error.code === PERMISSION_DENIED) {
          orgPermissionsBlocked = true;
          renderPermissionWarning();
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
              <h3>Error Loading Organizations</h3>
              <p>${error.message}</p>
            </div>
          `;
          BlacklinkUtils.showToast('Failed to load organizations', 'danger');
        }
      }
    }

    async function selectAdminOrg(orgId) {
      const isAdminOrg = adminOrganizations.some((org) => org.id === orgId);
      if (!isAdminOrg) {
        BlacklinkUtils.showToast('You no longer have admin access to this org.', 'warning');
        return;
      }

      selectedAdminOrgId = orgId;
      renderAdminOrganizations();

      try {
        const orgDoc = await db.collection('organizations').doc(orgId).get();
        if (!orgDoc.exists) {
          BlacklinkUtils.showToast('Organization not found', 'danger');
          return;
        }
        populateAdminConfigPanel(orgDoc.data(), orgId);
        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('organization_config_opened', { orgId });
        }
      } catch (error) {
        console.error('Error loading organization config:', error);
        if (error.code === PERMISSION_DENIED) {
          orgPermissionsBlocked = true;
          renderPermissionWarning();
        } else {
          BlacklinkUtils.showToast('Failed to load organization config', 'danger');
        }
      }
    }

    function populateAdminConfigPanel(orgData, orgId) {
      const configPanel = document.getElementById('admin-config-panel');
      if (!configPanel) return;

      document.getElementById('admin-config-title').textContent = `Configuring ${orgData.name || 'Organization'}`;
      document.getElementById('admin-config-name').value = orgData.name || '';
      document.getElementById('admin-config-description').value = orgData.description || '';
      document.getElementById('admin-config-tier').value = orgData.tier || 'FREE';
      document.getElementById('admin-config-credits').value = orgData.sharedCredits || 0;

      configPanel.classList.remove('hidden');
    }

    function resetAdminConfigPanel() {
      selectedAdminOrgId = null;
      document.getElementById('admin-config-form').reset();
      document.getElementById('admin-config-panel').classList.add('hidden');
      renderAdminOrganizations();
    }

    async function saveAdminOrgConfig(event) {
      event.preventDefault();
      if (!selectedAdminOrgId) {
        BlacklinkUtils.showToast('Select an organization first', 'warning');
        return;
      }

      const saveBtn = document.getElementById('admin-config-save-btn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      const name = document.getElementById('admin-config-name').value.trim();
      const description = document.getElementById('admin-config-description').value.trim();
      const tier = document.getElementById('admin-config-tier').value;
      const sharedCredits = Number(document.getElementById('admin-config-credits').value || 0);

      try {
        await db.collection('organizations').doc(selectedAdminOrgId).update({
          name,
          description,
          tier,
          sharedCredits
        });

        BlacklinkUtils.showToast('Organization updated', 'success');
        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('organization_config_saved', { tier });
        }
        loadOrganizations();
      } catch (error) {
        console.error('Error saving organization config:', error);
        if (error.code === PERMISSION_DENIED) {
          orgPermissionsBlocked = true;
          renderPermissionWarning();
        }
        BlacklinkUtils.showToast('Failed to save organization', 'danger');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
      }
    }

    window.openCreateOrgModal = () => {
      document.getElementById('create-org-modal').classList.add('active');
    };

    window.closeCreateOrgModal = () => {
      document.getElementById('create-org-modal').classList.remove('active');
      document.getElementById('create-org-form').reset();
    };

    window.createOrganization = async (event) => {
      event.preventDefault();

      const name = document.getElementById('org-name').value.trim();
      const description = document.getElementById('org-description').value.trim();
      const type = document.getElementById('org-type').value;

      if (!name || !type) {
        BlacklinkUtils.showToast('Name and type are required', 'warning');
        return;
      }

      try {
        const orgRef = await db.collection('organizations').add({
          name,
          description,
          type,
          owner: currentUser.uid,
          createdAt: FieldValue.serverTimestamp(),
          memberCount: 1,
          sharedCredits: 0,
          tier: 'FREE'
        });

        const ownerName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Owner';

        await db
          .collection('organizations')
          .doc(orgRef.id)
          .collection('members')
          .doc(currentUser.uid)
          .set({
            role: 'owner',
            email: currentUser.email || '',
            displayName: ownerName,
            joinedAt: FieldValue.serverTimestamp()
          });

        closeCreateOrgModal();
        BlacklinkUtils.showToast('Organization created', 'success');
        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('organization_created', { type });
        }
        loadOrganizations();
      } catch (error) {
        console.error('Error creating organization:', error);
        if (error.code === PERMISSION_DENIED) {
          orgPermissionsBlocked = true;
          renderPermissionWarning();
        }
        BlacklinkUtils.showToast('Failed to create organization', 'danger');
      }
    };

    window.viewOrganization = async (orgId) => {
      currentOrgId = orgId;
      const modal = document.getElementById('view-org-modal');

      try {
        const orgDoc = await db.collection('organizations').doc(orgId).get();
        if (!orgDoc.exists) {
          BlacklinkUtils.showToast('Organization not found', 'danger');
          return;
        }

        const orgData = orgDoc.data();
        document.getElementById('view-org-title').textContent = orgData.name;
        document.getElementById('org-member-count').textContent = orgData.memberCount || 1;
        document.getElementById('org-credits').textContent = orgData.sharedCredits || 0;
        document.getElementById('org-tier').textContent = orgData.tier || 'FREE';

        const membersSnapshot = await db
          .collection('organizations')
          .doc(orgId)
          .collection('members')
          .get();

        const membersList = document.getElementById('org-members-list');

        if (membersSnapshot.empty) {
          membersList.innerHTML = '<li class="empty-state"><p>No members found</p></li>';
        } else {
          membersList.innerHTML = membersSnapshot.docs.map((memberDoc) => {
            const member = memberDoc.data();
            const initial = (member.displayName || member.email || 'U').charAt(0).toUpperCase();
            return `
              <li class="member-item">
                <div class="member-info">
                  <div class="member-avatar">${initial}</div>
                  <div class="member-details">
                    <h4>${member.displayName || 'Unknown User'}</h4>
                    <p>${member.email || 'No email'}</p>
                  </div>
                </div>
                <div class="member-actions">
                  <span class="badge badge-${member.role || 'member'}">${member.role || 'member'}</span>
                </div>
              </li>
            `;
          }).join('');
        }

        modal.classList.add('active');
        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('organization_viewed', { orgId });
        }
      } catch (error) {
        console.error('Error loading organization:', error);
        if (error.code === PERMISSION_DENIED) {
          orgPermissionsBlocked = true;
          renderPermissionWarning();
        } else {
          BlacklinkUtils.showToast('Failed to load organization', 'danger');
        }
      }
    };

    window.closeViewOrgModal = () => {
      document.getElementById('view-org-modal').classList.remove('active');
      currentOrgId = null;
    };

    window.openInviteMemberModal = () => {
      BlacklinkUtils.showToast('Member invitations coming soon', 'info');
    };

    window.leaveOrganization = async () => {
      if (!currentOrgId) {
        BlacklinkUtils.showToast('Select an organization first', 'warning');
        return;
      }

      BlacklinkUtils.showToast('Leaving organizations requires backend automation. Contact support@blacklink.net.', 'info');
    };

    window.selectAdminOrg = selectAdminOrg;
    window.saveAdminOrgConfig = saveAdminOrgConfig;
    window.resetAdminConfigPanel = resetAdminConfigPanel;
  </script>
</body>

</html>
