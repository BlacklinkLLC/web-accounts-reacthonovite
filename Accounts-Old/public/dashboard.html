<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Blacklink</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Modular CSS (v3.9) -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/nav.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Analytics & Admin Stats */
    .stat-card {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }

    .stat-trend {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .admin-stat-card {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .admin-stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .admin-stat-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .admin-stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Theme Builder */
    .theme-color-input {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .theme-color-input label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .theme-color-input input[type="color"] {
      width: 60px;
      height: 40px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .welcome {
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
    }

    .welcome h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .welcome p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .release-banner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem 1.25rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(99, 102, 241, 0.35);
      background: rgba(99, 102, 241, 0.1);
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .release-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      background: rgba(251, 191, 36, 0.18);
      color: var(--primary-light);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.35px;
    }

    .release-note {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Tier Badge */
    .tier-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 700;
      color: white !important;
      -webkit-text-fill-color: white !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: pulse 2s ease-in-out infinite;
    }

    .tier-badge.ultra-plus {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    /* Aero Badge */
    .aero-badge {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
      border: 2px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      backdrop-filter: blur(10px);
    }

    .aero-icon {
      font-size: 2rem;
    }

    .aero-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .aero-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #10b981;
    }

    /* QuickLaunch Section */
    .quicklaunch {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 2px solid var(--border);
      box-shadow: var(--shadow-lg);
    }

    .quicklaunch-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .quicklaunch-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .quicklaunch-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .add-app-btn {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-app-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .quicklaunch-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .quicklaunch-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .quicklaunch-filters select {
      background: var(--bg);
      border: 2px solid var(--border);
      color: var(--text);
      padding: 0.6rem 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .quicklaunch-filters select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    .chip-toggle {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      background: var(--bg);
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .chip-toggle:hover {
      border-color: var(--primary-light);
      color: var(--primary-light);
    }

    .chip-toggle.active {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary-light);
      border-color: rgba(99, 102, 241, 0.4);
    }

    .search-apps {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .search-apps input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-apps input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1.25rem;
    }

    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1.5rem;
    }

    .quicklaunch-collections {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .collection-card {
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      background: var(--bg);
      display: grid;
      gap: 0.35rem;
    }

    .collection-card strong {
      font-size: 0.95rem;
      color: var(--text);
    }

    .collection-card span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .app-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 1.5rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid var(--border);
      position: relative;
      text-decoration: none;
      color: var(--text);
    }

    .app-card:hover {
      transform: translateY(-8px);
      border-color: var(--primary-light);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .app-card.favorite {
      border-color: rgba(254, 240, 138, 0.6);
      box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.35);
    }

    .app-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .app-icon img {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-sm);
      object-fit: cover;
    }

    .app-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .app-url {
      font-size: 0.75rem;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .app-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      opacity: 0;
      transition: var(--transition);
      display: flex;
    }

    .app-card:hover .app-actions {
      opacity: 1;
    }

    .app-action-btn {
      width: 28px;
      height: 28px;
      background: var(--card-bg);
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      margin-left: 0.25rem;
    }

    .app-action-btn:hover {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }

    .app-action-btn.favorite {
      color: #facc15;
    }

    .app-action-btn.favorite:hover {
      background: rgba(250, 204, 21, 0.15);
      color: #fde047;
    }

    .app-card.favorite .app-action-btn.favorite {
      color: #facc15;
    }

    .usage-chip {
      position: absolute;
      left: 0.75rem;
      top: 0.75rem;
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .usage-chip i {
      font-size: 0.65rem;
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      border-color: var(--primary-light);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-change {
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }

    .stat-change.positive {
      color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .stat-change.neutral {
      color: var(--text-muted);
      background: rgba(148, 163, 184, 0.1);
    }

    .experience-grid {
      margin-top: 2.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .panel-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 2px solid var(--border);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .panel-title {
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }

    .panel-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .panel-footer {
      margin-top: auto;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-footer a {
      color: var(--primary-light);
      font-weight: 600;
      text-decoration: none;
    }

    .panel-footer a:hover {
      text-decoration: underline;
    }

    .ultra-feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .ultra-feature-card {
      position: relative;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(99, 102, 241, 0.35);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(76, 29, 149, 0.2));
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--text);
      transition: var(--transition);
      cursor: pointer;
      min-height: 180px;
    }

    .ultra-feature-card:hover {
      transform: translateY(-6px);
      border-color: rgba(99, 102, 241, 0.6);
      box-shadow: 0 16px 40px rgba(99, 102, 241, 0.3);
    }

    .ultra-feature-card.locked {
      border-style: dashed;
      background: linear-gradient(135deg, rgba(148, 163, 184, 0.12), rgba(148, 163, 184, 0.08));
      opacity: 0.85;
    }

    .ultra-feature-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      background: rgba(15, 23, 42, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.05);
    }

    .ultra-feature-name {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .ultra-feature-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .feature-meta {
      margin-top: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .feature-tier-pill {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.5px;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid currentColor;
      font-weight: 600;
    }

    .feature-tier-pill.tier-ultra {
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.15);
    }

    .feature-tier-pill.tier-ultra-plus {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.15);
    }

    .feature-status {
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.55);
    }

    .feature-status.ready {
      color: #4ade80;
    }

    .feature-status.locked {
      color: #f87171;
      background: rgba(239, 68, 68, 0.15);
    }

    .admin-action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .admin-action-card {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(37, 99, 235, 0.35);
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.35), rgba(14, 116, 144, 0.25));
      padding: 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      text-align: left;
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      min-height: 160px;
    }

    .admin-action-card:hover {
      transform: translateY(-6px);
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 16px 40px rgba(59, 130, 246, 0.35);
    }

    .admin-action-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(148, 163, 184, 0.12);
      font-size: 1.25rem;
    }

    .admin-action-name {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .admin-action-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.35;
      flex: 1;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .metric-tile {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 0.85rem;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--primary-light);
    }

    .metric-subtext {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .data-table th,
    .data-table td {
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding: 0.6rem 0.4rem;
      text-align: left;
    }

    .data-table th {
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.4px;
      color: var(--text-muted);
    }

    .modal-loading {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .modal-loading::before {
      content: '';
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid rgba(99, 102, 241, 0.3);
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      padding: 0.75rem 0;
    }

    .release-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .release-item {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 0.85rem;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .release-primary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .release-name {
      font-weight: 600;
    }

    .release-stage {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.35);
    }

    .release-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .release-meta i {
      margin-right: 0.35rem;
      color: var(--primary-light);
    }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.4px;
    }

    .priority-badge.priority-urgent {
      background: rgba(248, 113, 113, 0.15);
      border: 1px solid rgba(248, 113, 113, 0.4);
      color: #f87171;
    }

    .priority-badge.priority-high {
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.4);
      color: #fbbf24;
    }

    .priority-badge.priority-normal {
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.35);
      color: var(--primary-light);
    }

    .priority-badge.priority-low {
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
    }

    .health-score {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      font-weight: 700;
    }

    .health-score-value {
      font-size: 2.5rem;
      color: var(--primary);
    }

    .health-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .health-checklist {
      list-style: none;
      display: grid;
      gap: 0.75rem;
    }

    .health-checklist li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .health-checklist .status {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
    }

    .status-ok {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-warn {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-need {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .activity-feed {
      display: grid;
      gap: 1rem;
      list-style: none;
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      padding: 0.9rem 1rem;
      border-radius: var(--radius-sm);
      background: var(--bg);
      border: 1px solid var(--border);
    }

    .activity-primary {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .activity-title {
      font-weight: 600;
    }

    .activity-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .activity-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .automation-list {
      list-style: none;
      display: grid;
      gap: 0.75rem;
    }

    .automation-item {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      background: var(--bg);
      display: grid;
      gap: 0.5rem;
    }

    .automation-item header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .automation-item p {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .automation-item button {
      justify-self: flex-start;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.8rem;
    }

    .automation-item button:hover {
      border-color: var(--primary);
      color: var(--primary-light);
    }

    .automation-log {
      margin-top: 1.5rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .automation-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .automation-log-header h3 {
      font-size: 1rem;
      font-weight: 600;
    }

    .automation-log-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .automation-log-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .automation-log-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.4);
    }

    .automation-log-item .log-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      background: rgba(99, 102, 241, 0.15);
      color: var(--primary-light);
    }

    .automation-log-item .log-meta {
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
    }

    .automation-log-item.success {
      border-color: rgba(34, 197, 94, 0.35);
      background: rgba(34, 197, 94, 0.08);
    }

    .automation-log-item.error {
      border-color: rgba(239, 68, 68, 0.35);
      background: rgba(239, 68, 68, 0.08);
    }

    .automation-log-item .log-meta span:last-child {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    body.focus-mode .quick-stats,
    body.focus-mode .experience-grid {
      opacity: 0.35;
      pointer-events: none;
    }

    body.focus-mode .quicklaunch {
      border-color: rgba(102, 126, 234, 0.6);
      box-shadow: 0 16px 32px rgba(102, 126, 234, 0.35);
    }

    body.focus-mode .focus-indicator {
      color: var(--primary-light);
    }


    /* Modal */
    .modal-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.85) !important;
      display: none !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 99999 !important;
      overflow: auto !important;
    }

    .modal-overlay.active {
      display: flex !important;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      position: relative;
      background: #1e293b !important;
      border-radius: var(--radius);
      width: 90% !important;
      max-width: 500px !important;
      max-height: 90vh !important;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 3px solid #6366f1 !important;
      z-index: 100001 !important;
      min-height: 200px;
      color: #f1f5f9 !important;
      margin: auto !important;
    }

    .modal-large {
      max-width: 900px !important;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 2rem;
      border-bottom: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    .modal-body {
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.875rem;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    .form-help {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary-light);
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      border-top: 2px solid var(--border);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .toast {
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-lg);
      border-left: 4px solid var(--primary);
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }

      .nav-links {
        display: none;
      }

      .container {
        padding: 1rem;
      }

      .welcome h1 {
        font-size: 1.75rem;
      }

      .apps-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 1rem;
      }

      .app-icon {
        width: 48px;
        height: 48px;
        font-size: 1.5rem;
      }

      .quicklaunch {
        padding: 1.5rem 1rem;
      }

      .quicklaunch-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .add-app-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Color Picker */
    .color-picker {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: var(--transition);
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }

    /* Roadmap Styles */
    .roadmap-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .roadmap-item {
      display: flex;
      gap: 1.25rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .roadmap-item:hover {
      border-color: var(--primary);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .roadmap-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .roadmap-content {
      flex: 1;
    }

    .roadmap-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .roadmap-description {
      color: var(--text-secondary);
      font-size: 0.9375rem;
      line-height: 1.6;
      margin-bottom: 0.75rem;
    }

    .roadmap-list {
      list-style: none;
      padding: 0;
      margin: 0.75rem 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .roadmap-list li {
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .roadmap-list li::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: var(--primary);
      font-weight: 700;
    }

    .roadmap-list strong {
      color: var(--text);
      font-weight: 600;
    }

    .roadmap-structure {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .roadmap-structure code {
      font-family: 'Courier New', monospace;
      color: var(--primary);
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
      display: inline-block;
    }

    .roadmap-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.875rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.75rem;
    }

    .ultra-badge {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .roadmap-footer {
      margin-top: 1rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .roadmap-footer p:first-child {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .roadmap-meta {
      font-size: 0.8125rem;
      font-style: italic;
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      .roadmap-item {
        flex-direction: column;
      }

      .roadmap-icon {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar Container (populated by navbar.js) -->
  <div id="navbar-container"></div>

  <!-- Main Content -->
  <main class="container">
    <div class="release-banner">
      <span class="release-badge">
        <i class="fas fa-code-branch"></i>
        v3.9 ‚Ä¢ Build 39C05022026
      </span>
      <span class="release-note">
        Stable automation presets, privacy center sync, and refreshed QuickLaunch intelligence are live.
      </span>
    </div>

    <div class="welcome">
      <div>
        <h1>Welcome back, <span id="welcomeName">User</span>! <span id="tierBadge" class="tier-badge"
            style="display: none;"></span></h1>
        <p>Launch your apps and manage your Blacklink experience</p>
      </div>
      <div id="aeroTokensBadge" class="aero-badge" style="display: none;">
        <div class="aero-icon">ü§ñ</div>
        <div class="aero-info">
          <div class="aero-label">Aero AI Credits</div>
          <div class="aero-value" id="aeroBalance">$0</div>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-rocket"></i>
          Total Apps
        </div>
        <div class="stat-value" id="totalApps">0</div>
        <div class="stat-change neutral">
          <span id="appsChange">No change</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-clock"></i>
          Quick Access
        </div>
        <div class="stat-value" id="quickAccess">0</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>Most used</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-folder"></i>
          Categories
        </div>
        <div class="stat-value" id="totalCategories">0</div>
        <div class="stat-change neutral">
          <span>Organize your apps</span>
        </div>
      </div>
    </div>

    <!-- QuickLaunch -->
    <div class="quicklaunch">
      <div class="quicklaunch-header">
        <div class="quicklaunch-title">
          <div class="quicklaunch-icon">
            <i class="fas fa-grip"></i>
          </div>
          <span>QuickLaunch</span>
        </div>
        <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
          <button class="chip-toggle" onclick="openPresetSelector()" type="button">
            <i class="fas fa-layer-group"></i>
            Load Preset
          </button>
          <button class="add-app-btn" onclick="openAddAppModal()">
            <i class="fas fa-plus"></i>
            Add Application
          </button>
          <button class="chip-toggle" id="smartOrganize" type="button">
            <i class="fas fa-wand-magic-sparkles"></i>
            Smart Organize
          </button>
        </div>
      </div>

      <div class="quicklaunch-toolbar">
        <div class="quicklaunch-filters">
          <label for="categoryFilter" class="sr-only">Filter by category</label>
          <select id="categoryFilter">
            <option value="all">All categories</option>
          </select>
          <button type="button" class="chip-toggle" id="favoritesOnlyToggle">
            <i class="fas fa-star"></i>
            Favorites
          </button>
        </div>
        <button type="button" class="chip-toggle" id="sortByUsage">
          <i class="fas fa-signal"></i>
          Sort by usage
        </button>
      </div>

      <div class="search-apps">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchApps" placeholder="Search your apps...">
      </div>

      <div class="apps-grid" id="appsGrid">
        <!-- Apps will be loaded here -->
      </div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">
          <i class="fas fa-inbox"></i>
        </div>
        <div class="empty-title">No apps yet</div>
        <p>Click "Add Application" to get started with QuickLaunch</p>
      </div>

      <div class="quicklaunch-collections" id="quicklaunchCollections" aria-live="polite"></div>
    </div>

    <div class="experience-grid">
      <section class="panel-card" id="accountHealthCard">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-heartbeat"></i>
            Account health
          </h2>
          <span class="panel-subtitle" id="healthSummary">Monitoring key metrics</span>
        </div>
        <div class="health-score">
          <span class="health-score-value" id="healthScore">0</span>
          <span class="health-meta" id="healthStatusLabel">Needs attention</span>
        </div>
        <ul class="health-checklist">
          <li>
            Add at least 3 apps
            <span class="status status-need" id="healthAppsStatus">Pending</span>
          </li>
          <li>
            Create 2 categories
            <span class="status status-need" id="healthCategoryStatus">Pending</span>
          </li>
          <li>
            Mark a favorite app
            <span class="status status-need" id="healthFavoriteStatus">Pending</span>
          </li>
        </ul>
      </section>

      <section class="panel-card">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-bolt"></i>
            Recent activity
          </h2>
          <button type="button" class="chip-toggle" id="refreshActivity">
            <i class="fas fa-rotate"></i>
            Refresh
          </button>
        </div>
        <p class="panel-subtitle">Track the most recent QuickLaunch usage to stay ahead of demand.</p>
        <ul class="activity-feed" id="activityFeed">
          <li class="activity-item" data-empty="true">
            <div class="activity-primary">
              <span class="activity-title">No app usage yet</span>
              <span class="activity-meta">Launch an app to start building your timeline.</span>
            </div>
            <span class="activity-badge">Idle</span>
          </li>
        </ul>
      </section>

      <section class="panel-card">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-sparkles"></i>
            Automation ideas
          </h2>
        </div>
        <p class="panel-subtitle">Accelerate repetitive tasks with lightweight workflows.</p>
        <ul class="automation-list" id="automationList">
          <li class="automation-item" data-automation="morning-launch">
            <header>
              <span>Morning launch set</span>
              <span class="activity-badge">Template</span>
            </header>
            <p>Open Classroom, Drive and Mail automatically at the start of the school day.</p>
            <button type="button">Create routine</button>
          </li>
          <li class="automation-item" data-automation="parent-comm">
            <header>
              <span>Parent communication bundle</span>
              <span class="activity-badge">Automation</span>
            </header>
            <p>Trigger SIS, Gmail and district newsletter tools from a single launch button.</p>
            <button type="button">Build bundle</button>
          </li>
          <li class="automation-item" data-automation="incident-response">
            <header>
              <span>Incident response prep</span>
              <span class="activity-badge">Beta</span>
            </header>
            <p>Keep your crisis contacts pinned and ready alongside documentation shortcuts.</p>
            <button type="button">Prepare kit</button>
          </li>
        </ul>
        <div class="automation-log" aria-live="polite">
          <div class="automation-log-header">
            <h3>Automation log</h3>
            <span>Runs stay on this device</span>
          </div>
          <ul class="automation-log-list" id="automationRunLog">
            <li class="automation-log-item empty">
              <div class="log-icon">‚öôÔ∏è</div>
              <div class="log-meta">
                <span>No automations yet</span>
                <span>Run a workflow to see history</span>
              </div>
            </li>
          </ul>
        </div>
      </section>

      <!-- Analytics Panel (ULTRA Feature) -->
      <section class="panel-card" id="analyticsPanel" style="display: none;">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-chart-line"></i>
            Usage Analytics & Insights
          </h2>
          <span class="feature-tier-pill tier-ultra">ULTRA</span>
        </div>
        <p class="panel-subtitle">Track your productivity patterns and app usage across Blacklink.</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="stat-card">
            <div class="stat-label">Total Launches</div>
            <div class="stat-value" id="totalLaunches">0</div>
            <div class="stat-trend">This week</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Apps</div>
            <div class="stat-value" id="activeApps">0</div>
            <div class="stat-trend">Unique apps used</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Daily Usage</div>
            <div class="stat-value" id="avgDaily">0</div>
            <div class="stat-trend">Launches per day</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Most Used</div>
            <div class="stat-value" id="topApp" style="font-size: 1.25rem;">-</div>
            <div class="stat-trend">Top application</div>
          </div>
        </div>

        <div class="panel-footer">
          <button class="btn btn-secondary" onclick="refreshAnalytics()">
            <i class="fas fa-refresh"></i>
            Refresh Data
          </button>
        </div>
      </section>

      <!-- Admin Control Center -->
      <section class="panel-card" id="adminControlCard" style="display: none;">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-shield-halved"></i>
            Admin Control Center
          </h2>
          <span class="feature-status ready" id="adminStatusPill" style="display: none;">
            <i class="fas fa-user-shield"></i>
            Admin verified
          </span>
        </div>
        <p class="panel-subtitle">
          Manage users, subscriptions, analytics, and system settings.
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="admin-stat-card">
            <div class="admin-stat-icon" style="background: rgba(99, 102, 241, 0.15); color: #6366f1;">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="admin-stat-value" id="adminTotalUsers">-</div>
              <div class="admin-stat-label">Total Users</div>
            </div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-icon" style="background: rgba(236, 72, 153, 0.15); color: #ec4899;">
              <i class="fas fa-crown"></i>
            </div>
            <div>
              <div class="admin-stat-value" id="adminUltraUsers">-</div>
              <div class="admin-stat-label">ULTRA Subscribers</div>
            </div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-icon" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">
              <i class="fas fa-check-circle"></i>
            </div>
            <div>
              <div class="admin-stat-value" id="adminActiveToday">-</div>
              <div class="admin-stat-label">Active Today</div>
            </div>
          </div>
        </div>

        <div class="admin-action-grid" id="adminUtilityGrid"></div>
        <div class="panel-footer" id="adminControlFooter">
          <a href="admin.html" class="btn btn-primary">
            <i class="fas fa-external-link-alt"></i>
            Open Full Admin Console
          </a>
        </div>
      </section>
    </div>
  </main>

  <!-- Add/Edit App Modal -->
  <div class="modal-overlay" id="appModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Add Application</h2>
        <button class="modal-close" onclick="closeAppModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="appForm" onsubmit="saveApp(event)">
          <div class="form-group">
            <label class="form-label" for="appName">Application Name *</label>
            <input type="text" class="form-input" id="appName" required placeholder="e.g., Google Drive">
          </div>

          <div class="form-group">
            <label class="form-label" for="appUrl">URL *</label>
            <input type="url" class="form-input" id="appUrl" required placeholder="https://drive.google.com">
            <div class="form-help">Enter the full URL including https://</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="appCategory">Category</label>
            <input type="text" class="form-input" id="appCategory" placeholder="e.g., Productivity, Education">
            <div class="form-help">Optional: helps organize your apps</div>
          </div>

          <div class="form-group">
            <label class="form-label">Icon Color</label>
            <div class="color-picker">
              <div class="color-option selected" style="background: linear-gradient(135deg, #667eea, #764ba2);"
                data-color="purple"></div>
              <div class="color-option" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"
                data-color="blue"></div>
              <div class="color-option" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"
                data-color="green"></div>
              <div class="color-option" style="background: linear-gradient(135deg, #fa709a, #fee140);"
                data-color="pink"></div>
              <div class="color-option" style="background: linear-gradient(135deg, #ff9a56, #ff6a88);"
                data-color="orange"></div>
              <div class="color-option" style="background: linear-gradient(135deg, #a8edea, #fed6e3);"
                data-color="cyan"></div>
            </div>
          </div>

          <input type="hidden" id="appId">
          <input type="hidden" id="appColor" value="purple">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeAppModal()">Cancel</button>
        <button type="submit" form="appForm" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Save Application
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="adminModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="adminModalTitle">Admin tools</h2>
        <button class="modal-close" type="button" onclick="closeAdminModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="adminModalBody">
        <p class="panel-subtitle">Select an admin action to view details.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeAdminModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Theme Builder Modal (ULTRA+ Feature) -->
  <div id="themeBuilderModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 999999;">
    <div style="background: white; width: 90%; max-width: 900px; border-radius: 12px; color: black; padding: 2rem;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <h2 class="modal-title">
            <i class="fas fa-palette"></i>
            Custom Theme Builder
          </h2>
          <span class="feature-tier-pill tier-ultra-plus">ULTRA+ BETA</span>
        </div>
        <button class="modal-close" type="button" onclick="closeThemeBuilder()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
          Create your own custom theme by selecting colors for different UI elements. Your theme will be saved to your account.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div>
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Color Settings</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div class="theme-color-input">
                <label>Background Color</label>
                <input type="color" id="themeBgColor" value="#0f172a">
              </div>
              <div class="theme-color-input">
                <label>Text Color</label>
                <input type="color" id="themeTextColor" value="#f1f5f9">
              </div>
              <div class="theme-color-input">
                <label>Primary Accent</label>
                <input type="color" id="themePrimaryColor" value="#6366f1">
              </div>
              <div class="theme-color-input">
                <label>Card Background</label>
                <input type="color" id="themeCardBg" value="#1e293b">
              </div>
              <div class="theme-color-input">
                <label>Border Color</label>
                <input type="color" id="themeBorderColor" value="#334155">
              </div>
            </div>

            <div style="margin-top: 1.5rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Theme Name</label>
              <input type="text" id="themeNameInput" placeholder="My Custom Theme" class="form-input" style="width: 100%;">
            </div>
          </div>

          <div>
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Preview</h3>
            <div id="themePreview" style="background: #0f172a; border: 2px solid #334155; border-radius: var(--radius); padding: 1.5rem; min-height: 300px;">
              <div style="background: #1e293b; border: 1px solid #334155; border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem;">
                <div style="color: #f1f5f9; font-weight: 600; margin-bottom: 0.5rem;">Sample Card</div>
                <div style="color: rgba(241, 245, 249, 0.7); font-size: 0.875rem;">This is how your theme will look</div>
                <button style="margin-top: 0.75rem; background: #6366f1; color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-sm); cursor: pointer;">Primary Button</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1.5rem 2rem; border-top: 2px solid var(--border);">
        <button type="button" class="btn btn-secondary" onclick="closeThemeBuilder()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveCustomTheme()">
          <i class="fas fa-save"></i>
          Save Theme
        </button>
      </div>
    </div>
  </div>

  <!-- Preset Selector Modal -->
  <div class="modal-overlay" id="presetModal" onclick="if(event.target === this) closePresetSelector()">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-layer-group"></i>
          Load QuickLaunch Preset
        </h2>
        <button class="close-btn" type="button" onclick="closePresetSelector()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
          Choose a curated preset to quickly set up your QuickLaunch apps based on your role.
        </p>
        <div id="presetGrid" class="grid grid-2" style="gap: 1rem;">
          <!-- Preset cards will be loaded here -->
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button type="button" class="btn btn-secondary" onclick="closePresetSelector()">
          Cancel
        </button>
        <button type="button" class="btn" onclick="createCustomPreset()">
          <i class="fas fa-wand-magic"></i>
          Create Custom
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modular JavaScript -->
  <script src="js/navbar.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/analytics-compat.js"></script>
  <script src="js/qlPresetLoader.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDh1cCQXw1TGVJdVVgLEGdOgZlTPzGORLw",
      authDomain: "blacklink-auth.firebaseapp.com",
      databaseURL: "https://blacklink-auth-default-rtdb.firebaseio.com",
      projectId: "blacklink-auth",
      storageBucket: "blacklink-auth.firebasestorage.app",
      messagingSenderId: "457832218084",
      appId: "1:457832218084:web:97ed6014a2ba6a6d789bf1",
      measurementId: "G-YXBK4L3VPL"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Initialize modular navbar
    Navbar.initNavbar(auth, db, {
      currentPage: 'dashboard',
      logoutHandler: async () => {
        try {
          const shouldLogout = window.confirm('Sign out of Blacklink?');
          if (!shouldLogout) {
            return;
          }
          await auth.signOut();
          window.location.href = 'login.html';
        } catch (error) {
          console.error('Error signing out:', error);
          showToast('Error signing out', 'error');
        }
      }
    });

    // Utility function for tier normalization
    function normalizeTier(tier) {
      if (!tier) return 'FREE';
      const value = String(tier).toUpperCase().replace(/\s+/g, '_');
      // Employee tier gets ULTRA_PLUS access
      if (value.includes('EMPLOYEE')) return 'ULTRA_PLUS';
      if (value === 'ULTRA_PLUS' || value === 'ULTRA+') return 'ULTRA_PLUS';
      if (value === 'ULTRA' || value.includes('DISTRICT')) return 'ULTRA';
      return 'FREE';
    }

    let currentUser = null;
    let userApps = [];
    let editingAppId = null;
    let favoriteAppIds = new Set();
    let currentSearchTerm = '';
    let activeCategory = 'all';
    let favoritesOnly = false;
    let sortByUsage = false;
    let adminUtilityCatalog = [];
    let subscriptionTier = 'FREE';
    let isAdmin = false;
    let currentUserData = null;
    let aeroTokens = null;
    let adminMetricsCache = null;
    let adminMetricsFetchedAt = 0;

    const favoriteStorageKey = 'blacklink-favorite-apps';
    const focusModeStorageKey = 'blacklink-focus-mode';
    const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    const categoryFilter = document.getElementById('categoryFilter');
    const favoritesOnlyToggle = document.getElementById('favoritesOnlyToggle');
    const sortByUsageButton = document.getElementById('sortByUsage');
    const focusModeToggle = document.getElementById('focusModeToggle');
    const focusIndicator = document.querySelector('.focus-indicator');
    const refreshActivityButton = document.getElementById('refreshActivity');
    const activityFeed = document.getElementById('activityFeed');
    const searchInput = document.getElementById('searchApps');
    const healthScoreEl = document.getElementById('healthScore');
    const healthStatusLabel = document.getElementById('healthStatusLabel');
    const healthSummary = document.getElementById('healthSummary');
    const healthAppsStatus = document.getElementById('healthAppsStatus');
    const healthCategoryStatus = document.getElementById('healthCategoryStatus');
    const healthFavoriteStatus = document.getElementById('healthFavoriteStatus');
    const automationList = document.getElementById('automationList');
    const automationRunLog = document.getElementById('automationRunLog');
    const quicklaunchCollections = document.getElementById('quicklaunchCollections');
    const smartOrganizeButton = document.getElementById('smartOrganize');
    const adminControlCard = document.getElementById('adminControlCard');
    const adminStatusPill = document.getElementById('adminStatusPill');
    const adminUtilityGrid = document.getElementById('adminUtilityGrid');
    const adminControlFooter = document.getElementById('adminControlFooter');
    const adminModal = document.getElementById('adminModal');
    const adminModalTitle = document.getElementById('adminModalTitle');
    const adminModalBody = document.getElementById('adminModalBody');
    const QUICK_LAUNCH_ROOT = 'product_pulse';
    const QUICK_LAUNCH_SUBCOLLECTION = 'quicklaunch';
    const preconfiguredApps = [
      {
        name: 'aeroAI',
        url: 'https://aero.blacklink.net',
        category: 'Blacklink Suite',
        color: 'cyan',
        icon: 'üõ©Ô∏è'
      },
      {
        name: 'Trust',
        url: 'https://trust.blacklink.net',
        category: 'Blacklink Suite',
        color: 'green',
        icon: 'üõ°Ô∏è'
      },
      {
        name: 'Note25/26',
        url: 'https://note.blacklink.net',
        category: 'Productivity',
        color: 'orange',
        icon: 'üóíÔ∏è'
      },
      {
        name: 'Design system',
        url: 'https://nova.blacklink.net',
        category: 'Resources',
        color: 'blue',
        icon: 'üìö'
      },
      {
        name: 'Blacklink',
        url: 'https://blacklink.net',
        category: 'Blacklink Suite',
        color: 'purple',
        icon: 'üöÄ'
      }
    ];

    const automationPresets = {
      'morning-launch': [
        { name: 'Google Classroom', url: 'https://classroom.google.com', category: 'Instruction', color: 'green', icon: 'üìò' },
        { name: 'Google Drive', url: 'https://drive.google.com', category: 'Files', color: 'blue', icon: 'üíæ' },
        { name: 'Gmail', url: 'https://mail.google.com', category: 'Communication', color: 'orange', icon: '‚úâÔ∏è' }
      ],
      'parent-comm': [
        { name: 'ParentSquare', url: 'https://www.parentsquare.com', category: 'Communication', color: 'pink', icon: 'üë™' },
        { name: 'SIS Portal', url: 'https://sis.blacklink.net', category: 'Operations', color: 'purple', icon: 'üóÉÔ∏è' },
        { name: 'Newsletter Studio', url: 'https://studio.blacklink.net/newsletter', category: 'Communication', color: 'cyan', icon: 'üì∞' }
      ],
      'incident-response': [
        { name: 'Incident Handbook', url: 'https://blacklink.net/incident-guide', category: 'Safety', color: 'orange', icon: 'üìï' },
        { name: 'Rapid Alert', url: 'https://alerts.blacklink.net', category: 'Safety', color: 'pink', icon: 'üö®' },
        { name: 'Contacts Sheet', url: 'https://sheets.google.com/incident', category: 'Operations', color: 'blue', icon: 'üìÑ' }
      ]
    };

    const automationDefinitions = {
      'smart-organize': {
        title: 'Smart organize',
        icon: 'üóÇÔ∏è',
        handler: runSmartOrganizeAutomation
      },
      'morning-launch': {
        title: 'Morning launch set',
        icon: 'üåÖ',
        handler: () => ensurePresetApps(automationPresets['morning-launch'], {
          markFavorite: true,
          updateCategory: true,
          tags: ['routine']
        })
      },
      'parent-comm': {
        title: 'Parent communication bundle',
        icon: 'üí¨',
        handler: () => ensurePresetApps(automationPresets['parent-comm'], {
          markFavorite: true,
          updateCategory: true,
          tags: ['parent-comm']
        })
      },
      'incident-response': {
        title: 'Incident response kit',
        icon: 'üõ°Ô∏è',
        handler: () => ensurePresetApps(automationPresets['incident-response'], {
          updateCategory: true,
          tags: ['incident-kit']
        })
      }
    };

    const automationLogEntries = [];

    // Color gradients map
    const colorGradients = {
      purple: 'linear-gradient(135deg, #667eea, #764ba2)',
      blue: 'linear-gradient(135deg, #4facfe, #00f2fe)',
      green: 'linear-gradient(135deg, #43e97b, #38f9d7)',
      pink: 'linear-gradient(135deg, #fa709a, #fee140)',
      orange: 'linear-gradient(135deg, #ff9a56, #ff6a88)',
      cyan: 'linear-gradient(135deg, #a8edea, #fed6e3)'
    };

    function quickLaunchCollection() {
      if (!currentUser) {
        throw new Error('User not authenticated');
      }
      return db
        .collection(QUICK_LAUNCH_ROOT)
        .doc(currentUser.uid)
        .collection(QUICK_LAUNCH_SUBCOLLECTION);
    }

    try {
      const storedFavorites = JSON.parse(localStorage.getItem(favoriteStorageKey));
      if (Array.isArray(storedFavorites)) {
        favoriteAppIds = new Set(storedFavorites);
      }
    } catch (error) {
      console.warn('Unable to read favorites from storage', error);
    }

    const storedFocusMode = localStorage.getItem(focusModeStorageKey);
    if (storedFocusMode === 'true') {
      setFocusMode(true);
    }

    if (focusModeToggle && !focusModeToggle.hasAttribute('aria-pressed')) {
      focusModeToggle.setAttribute('aria-pressed', String(document.body.classList.contains('focus-mode')));
    }

    if (searchInput) {
      searchInput.addEventListener('input', () => filterApps());
    }

    categoryFilter?.addEventListener('change', (event) => {
      activeCategory = event.target.value;
      renderApps();
      updateStats();
    });

    if (favoritesOnlyToggle) {
      favoritesOnlyToggle.setAttribute('aria-pressed', 'false');
    }

    favoritesOnlyToggle?.addEventListener('click', () => {
      favoritesOnly = !favoritesOnly;
      favoritesOnlyToggle.classList.toggle('active', favoritesOnly);
      favoritesOnlyToggle.setAttribute('aria-pressed', String(favoritesOnly));
      renderApps();
      updateStats();
    });

    if (sortByUsageButton) {
      sortByUsageButton.setAttribute('aria-pressed', 'false');
    }

    sortByUsageButton?.addEventListener('click', () => {
      sortByUsage = !sortByUsage;
      sortByUsageButton.classList.toggle('active', sortByUsage);
      sortByUsageButton.innerHTML = sortByUsage
        ? '<i class="fas fa-signal"></i> Usage priority'
        : '<i class="fas fa-signal"></i> Sort by usage';
      sortByUsageButton.setAttribute('aria-pressed', String(sortByUsage));
      renderApps();
      updateStats();
    });

    adminUtilityGrid?.addEventListener('click', (event) => {
      const target = event.target.closest('[data-action]');
      if (!target) return;
      const action = target.getAttribute('data-action');
      if (!action) return;
      handleAdminUtilityAction(action, target.dataset.id || null);
    });

    focusModeToggle?.addEventListener('click', () => {
      const isActive = document.body.classList.contains('focus-mode');
      setFocusMode(!isActive);
    });

    refreshActivityButton?.addEventListener('click', () => {
      renderActivityFeed();
      showToast('Activity feed refreshed', 'info');
    });

    if (automationList) {
      automationList.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
          const automationId = button.closest('.automation-item')?.dataset.automation;
          if (!automationId) return;
          runAutomation(automationId, button);
        });
      });
    }

    if (smartOrganizeButton) {
      smartOrganizeButton.addEventListener('click', () => runAutomation('smart-organize', smartOrganizeButton));
    }

    quicklaunchCollections?.addEventListener('click', (event) => {
      const actionButton = event.target.closest('[data-automation-action]');
      if (!actionButton) return;
      const actionId = actionButton.dataset.automationAction;
      if (!actionId) return;
      runAutomation(actionId, actionButton);
    });

    // Auth State
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;

      try {
        await loadUserData();
        // Cloud Function not deployed yet - subscription data loaded from Firestore in loadUserData()
        // await loadSubscriptionBadge();
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Unable to load your profile details', 'error');
      }

      let seeded = false;
      try {
        seeded = await seedPreconfiguredApps();
      } catch (error) {
        console.error('Error seeding preconfigured apps:', error);
        showToast('Unable to add starter apps', 'error');
      }

      try {
        await loadApps();
      } catch (error) {
        console.error('Error loading apps:', error);
        showToast('Unable to load dashboard data', 'error');
        return;
      }

      if (seeded) {
        showToast('We added Blacklink starter apps to your QuickLaunch.', 'success');
      }
    });

    // Load User Data
    async function loadUserData() {
      try {
        const [userDoc, subscriptionDoc] = await Promise.all([
          db.collection('users').doc(currentUser.uid).get(),
          db.collection('subscriptions').doc(currentUser.uid).get().catch(() => null)
        ]);

        currentUserData = userDoc.data() || {};

        if (subscriptionDoc && subscriptionDoc.exists) {
          const subscriptionData = subscriptionDoc.data() || {};
          currentUserData.subscription = {
            ...(currentUserData.subscription || {}),
            ...subscriptionData
          };
        }

        const displayName = currentUserData.name || currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
        document.getElementById('welcomeName').textContent = displayName;

        const initials = displayName
          .split(' ')
          .map((n) => n[0])
          .join('')
          .substring(0, 2)
          .toUpperCase();

        const normalizedTier = normalizeTier(currentUserData?.subscription?.tier);
        subscriptionTier = normalizedTier || subscriptionTier;

        if (currentUserData?.subscription?.aeroTokens) {
          const tokens = currentUserData.subscription.aeroTokens;
          aeroTokens = {
            remaining: tokens.remaining ?? tokens.balance ?? tokens,
            monthly: tokens.monthly ?? tokens.allocation ?? currentUserData.subscription?.aeroTokensMonthly ?? null,
            used: tokens.used ?? null
          };
        } else if (typeof currentUserData?.aeroTokens === 'number') {
          aeroTokens = {
            remaining: currentUserData.aeroTokens,
            monthly: currentUserData.subscription?.aeroTokensMonthly || null
          };
        }

        window.Navbar?.setUser({
          displayName,
          initials,
          tier: subscriptionTier,
          photoURL: currentUserData?.photoURL || currentUser.photoURL || null,
          email: currentUser.email,
          isAdmin
        });

        isAdmin = currentUserData?.isAdmin === true;
        if (adminStatusPill) {
          adminStatusPill.style.display = isAdmin ? 'inline-flex' : 'none';
        }

        updateTierElements(subscriptionTier);
        renderAdminUtilities();
        updateAeroBadge();
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }

    // Load Subscription Badge
    async function loadSubscriptionBadge() {
      try {
        const token = await currentUser.getIdToken();
        const response = await fetch(`https://us-central1-blacklink-auth.cloudfunctions.net/getSubscriptionStatus`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) return;

        const subData = await response.json();
        const tier = normalizeTier(subData.tier || 'FREE');

        if (subData.aeroTokens) {
          aeroTokens = {
            monthly: subData.aeroTokens.monthly,
            remaining: subData.aeroTokens.remaining,
            used: subData.aeroTokens.used
          };
        }

        updateTierElements(tier, aeroTokens);
        updateAeroBadge();
      } catch (error) {
        console.error('Error loading subscription badge:', error);
      }
    }

    // Load Apps from basic.qlConfig + Firestore
    async function loadApps() {
      try {
        // Load default apps from basic.qlConfig
        const configResponse = await fetch('./js/basic.qlConfig');
        const config = await configResponse.json();
        const defaultApps = config.defaultApps || [];
        adminUtilityCatalog = Array.isArray(config.adminUtilities) ? config.adminUtilities : [];
        renderAdminUtilities();

        // Load user's custom apps from Firestore
        const appsSnapshot = await quickLaunchCollection()
          .orderBy('createdAt', 'desc')
          .get();

        userApps = [];

        // Add default apps first (marked as default)
        defaultApps.forEach(app => {
          userApps.push({
            ...app,
            isDefault: true,
            createdAt: new Date(),
            usage: 0
          });
        });

        // Add user's custom apps
        appsSnapshot.forEach(doc => {
          const data = doc.data();

          // Skip if this is a duplicate of a default app (by ID or URL)
          const isDuplicate = defaultApps.some(defApp =>
            defApp.id === doc.id || defApp.url === data.url
          );

          if (!isDuplicate) {
            const app = { id: doc.id, ...data };

            if (data.lastUsed?.toDate) {
              app.lastUsed = data.lastUsed.toDate();
            } else if (data.lastUsed && data.lastUsed.seconds) {
              app.lastUsed = new Date(data.lastUsed.seconds * 1000);
            }

            if (data.createdAt?.toDate) {
              app.createdAt = data.createdAt.toDate();
            }

            app.usage = data.usage || 0;
            userApps.push(app);
          }
        });

        syncFavoriteSet();
        populateCategoryFilter();
        renderApps();
        updateStats();
        updateAccountHealth();
        renderActivityFeed();
      } catch (error) {
        console.error('Error loading apps:', error);
        showToast('Error loading apps. Loading from Firestore only...', 'error');
        premiumFeaturesCatalog = [];
        adminUtilityCatalog = [];
        renderAdminUtilities();

        // Fallback: load from Firestore only
        try {
          const appsSnapshot = await quickLaunchCollection().orderBy('createdAt', 'desc').get();
          userApps = [];
          appsSnapshot.forEach(doc => {
            const data = doc.data();
            const app = { id: doc.id, ...data };
            if (data.lastUsed?.toDate) app.lastUsed = data.lastUsed.toDate();
            if (data.createdAt?.toDate) app.createdAt = data.createdAt.toDate();
            app.usage = data.usage || 0;
            userApps.push(app);
          });
          renderApps();
        } catch (fallbackError) {
          console.error('Fallback loading failed:', fallbackError);
        }
      }
    }

    function getFilteredApps() {
      let apps = [...userApps];

      if (currentSearchTerm) {
        apps = apps.filter(app =>
          app.name?.toLowerCase().includes(currentSearchTerm) ||
          app.url?.toLowerCase().includes(currentSearchTerm) ||
          (app.category && app.category.toLowerCase().includes(currentSearchTerm))
        );
      }

      if (activeCategory !== 'all') {
        const targetCategory = activeCategory.toLowerCase();
        apps = apps.filter(app => (app.category || '').toLowerCase() === targetCategory);
      }

      if (favoritesOnly) {
        apps = apps.filter(app => favoriteAppIds.has(app.id));
      }

      if (sortByUsage) {
        apps.sort((a, b) => (b.usage || 0) - (a.usage || 0));
      } else {
        apps.sort((a, b) => {
          const aTime = a.createdAt instanceof Date ? a.createdAt.getTime() : 0;
          const bTime = b.createdAt instanceof Date ? b.createdAt.getTime() : 0;
          return bTime - aTime;
        });
      }

      return apps;
    }

    function resolveHostname(url) {
      if (!url) return '';
      try {
        return new URL(url).hostname;
      } catch (error) {
        return url.replace(/^https?:\/\//i, '').split('/')[0];
      }
    }

    function normalizeHostname(url) {
      return resolveHostname(url).toLowerCase();
    }

    // Render Apps
    function renderApps() {
      const appsGrid = document.getElementById('appsGrid');
      const emptyState = document.getElementById('emptyState');
      const apps = getFilteredApps();

      if (apps.length === 0) {
        appsGrid.style.display = 'none';
        emptyState.style.display = 'block';
        renderQuicklaunchCollections();
        return;
      }

      appsGrid.style.display = 'grid';
      emptyState.style.display = 'none';
      appsGrid.innerHTML = '';

      apps.forEach(app => {
        const appCard = document.createElement('a');
        appCard.href = app.url;
        appCard.target = '_blank';
        appCard.rel = 'noopener noreferrer';
        const isFavorite = favoriteAppIds.has(app.id);
        appCard.className = isFavorite ? 'app-card favorite' : 'app-card';
        const hostname = resolveHostname(app.url);
        const usageCount = app.usage || 0;
        const displayIcon = app.icon || (app.name ? app.name.charAt(0).toUpperCase() : '‚òÖ');
        appCard.innerHTML = `
          <span class="usage-chip"><i class="fas fa-bolt"></i>${usageCount}</span>
          <div class="app-actions">
            <button class="app-action-btn favorite" onclick="event.preventDefault(); event.stopPropagation(); toggleFavorite('${app.id}')" title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
              <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
            </button>
            <button class="app-action-btn" onclick="event.preventDefault(); event.stopPropagation(); editApp('${app.id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="app-action-btn" onclick="event.preventDefault(); event.stopPropagation(); deleteApp('${app.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="app-icon" style="background: ${colorGradients[app.color] || colorGradients.purple}">
            ${displayIcon}
          </div>
          <div class="app-name">${app.name}</div>
          <div class="app-url">${hostname}</div>
        `;

        // Track click
        appCard.addEventListener('click', () => {
          incrementAppUsage(app.id);
        });

        appsGrid.appendChild(appCard);
      });

      renderQuicklaunchCollections();
    }

    function renderQuicklaunchCollections() {
      if (!quicklaunchCollections) return;

      if (!userApps.length) {
        quicklaunchCollections.innerHTML = `
          <div class="collection-card">
            <strong>Ready when you are</strong>
            <span>Add apps to start building smart collections.</span>
          </div>
        `;
        return;
      }

      const uncategorized = userApps.filter(app => !app.category && !app.isDefault && app.id);
      const recentApps = userApps
        .filter(app => app.createdAt instanceof Date && !app.isDefault)
        .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())
        .slice(0, 3);
      const parentComm = userApps.filter(app => hasAutomationTag(app, 'parent-comm'));
      const incidentKit = userApps.filter(app => hasAutomationTag(app, 'incident-kit'));

      const cards = [
        {
          id: 'favorites',
          title: 'Favorites',
          description: favoriteAppIds.size
            ? `${favoriteAppIds.size} app${favoriteAppIds.size === 1 ? '' : 's'} pinned`
            : 'Star apps to pin them here.'
        },
        {
          id: 'recent',
          title: 'Recently added',
          description: recentApps.length
            ? recentApps.map(app => app.name).join(', ')
            : 'Add apps to build recents.'
        },
        {
          id: 'uncategorized',
          title: 'Needs categories',
          description: uncategorized.length
            ? `${uncategorized.length} app${uncategorized.length === 1 ? '' : 's'} waiting for tags`
            : 'Everything is organized',
          action: uncategorized.length ? 'smart-organize' : null
        },
        {
          id: 'parent-comm',
          title: 'Parent communication',
          description: parentComm.length
            ? `${parentComm.length} tools linked`
            : 'Build the communication bundle',
          action: parentComm.length ? null : 'parent-comm'
        },
        {
          id: 'incident-kit',
          title: 'Incident response kit',
          description: incidentKit.length
            ? `${incidentKit.length} shortcuts ready`
            : 'Prepare your crisis resources',
          action: incidentKit.length ? null : 'incident-response'
        }
      ];

      quicklaunchCollections.innerHTML = cards.map(card => `
        <div class="collection-card">
          <strong>${card.title}</strong>
          <span>${card.description}</span>
          ${card.action ? `<button type="button" class="chip-toggle" data-automation-action="${card.action}">Run</button>` : ''}
        </div>
      `).join('');
    }

    function hasAutomationTag(app, tag) {
      return Array.isArray(app?.tags) && app.tags.includes(tag);
    }

    async function runAutomation(automationId, triggerButton) {
      const automation = automationDefinitions[automationId];
      if (!automation) {
        showToast('Automation is not available yet', 'info');
        return;
      }

      const originalLabel = triggerButton ? triggerButton.innerHTML : null;
      if (triggerButton) {
        triggerButton.disabled = true;
        triggerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      try {
        const result = await automation.handler();
        logAutomationRun({
          title: automation.title,
          icon: automation.icon,
          detail: result?.message || 'Automation completed',
          status: 'success'
        });
        if (result?.message) {
          showToast(result.message, 'success');
        } else {
          showToast(`${automation.title} completed`, 'success');
        }
      } catch (error) {
        console.error('Automation error:', error);
        logAutomationRun({
          title: automation.title,
          icon: automation.icon,
          detail: error.message || 'Automation failed',
          status: 'error'
        });
        showToast(error.message || 'Automation failed', 'error');
      } finally {
        if (triggerButton) {
          triggerButton.disabled = false;
          triggerButton.innerHTML = originalLabel || 'Run';
        }
        renderQuicklaunchCollections();
      }
    }

    function logAutomationRun(entry) {
      automationLogEntries.unshift({
        ...entry,
        timestamp: entry.timestamp ? new Date(entry.timestamp) : new Date()
      });
      if (automationLogEntries.length > 8) {
        automationLogEntries.pop();
      }
      renderAutomationLog();
    }

    function renderAutomationLog() {
      if (!automationRunLog) return;

      if (!automationLogEntries.length) {
        automationRunLog.innerHTML = `
          <li class="automation-log-item empty">
            <div class="log-icon">‚öôÔ∏è</div>
            <div class="log-meta">
              <span>No automations yet</span>
              <span>Run a workflow to see history</span>
            </div>
          </li>
        `;
        return;
      }

      automationRunLog.innerHTML = automationLogEntries.map(entry => {
        const relative = formatRelativeTime(entry.timestamp);
        return `
          <li class="automation-log-item ${entry.status || 'success'}">
            <div class="log-icon">${entry.icon || '‚öôÔ∏è'}</div>
            <div class="log-meta">
              <span>${entry.title}</span>
              <span>${entry.detail} ‚Ä¢ ${relative}</span>
            </div>
          </li>
        `;
      }).join('');
    }

    async function runSmartOrganizeAutomation() {
      if (!currentUser) {
        throw new Error('Sign in to run this automation');
      }

      const uncategorized = userApps.filter(app => !app.category && !app.isDefault && app.id);
      if (!uncategorized.length) {
        return { message: 'Everything is already organized.' };
      }

      const collectionRef = quickLaunchCollection();
      const batch = db.batch();
      const now = firebase.firestore.FieldValue.serverTimestamp();

      uncategorized.forEach(app => {
        const category = guessCategory(app);
        batch.update(collectionRef.doc(app.id), {
          category,
          updatedAt: now
        });
      });

      await batch.commit();
      await loadApps();
      return { message: `Categorized ${uncategorized.length} app${uncategorized.length === 1 ? '' : 's'}.` };
    }

    async function ensurePresetApps(presetApps, options = {}) {
      if (!currentUser) {
        throw new Error('Sign in to run this automation');
      }

      const collectionRef = quickLaunchCollection();
      const now = firebase.firestore.FieldValue.serverTimestamp();
      const hostMap = new Map(userApps.map(app => [normalizeHostname(app.url), app]));
      const batch = db.batch();
      const createdIds = [];
      let updatedCount = 0;
      const tagsToApply = Array.isArray(options.tags) ? options.tags : [];

      presetApps.forEach(preset => {
        const host = normalizeHostname(preset.url);
        const existing = hostMap.get(host);

        if (!existing) {
          const docRef = collectionRef.doc();
          batch.set(docRef, {
            ...preset,
            userId: currentUser.uid,
            usage: 0,
            tags: tagsToApply,
            createdAt: now,
            updatedAt: now
          });
          createdIds.push(docRef.id);
        } else if (!existing.isDefault && existing.id) {
          const updateData = {};
          if (options.updateCategory && !existing.category) {
            updateData.category = preset.category;
          }
          if (tagsToApply.length) {
            updateData.tags = firebase.firestore.FieldValue.arrayUnion(...tagsToApply);
          }
          if (Object.keys(updateData).length) {
            updateData.updatedAt = now;
            batch.update(collectionRef.doc(existing.id), updateData);
            updatedCount += 1;
          }
          if (options.markFavorite) {
            favoriteAppIds.add(existing.id);
          }
        } else if (options.markFavorite && existing?.id) {
          favoriteAppIds.add(existing.id);
        }
      });

      const hasBatchOps = createdIds.length > 0 || updatedCount > 0;
      if (hasBatchOps) {
        await batch.commit();
      }

      if (options.markFavorite) {
        createdIds.forEach(id => favoriteAppIds.add(id));
        persistFavorites();
      }

      if (hasBatchOps) {
        await loadApps();
      } else {
        renderApps();
      }

      const responseMessage = createdIds.length
        ? `Added ${createdIds.length} app${createdIds.length === 1 ? '' : 's'}${options.markFavorite ? ' and pinned them' : ''}.`
        : updatedCount
          ? 'Updated existing tools with new metadata.'
          : options.markFavorite
            ? 'Pinned existing tools to your favorites.'
            : 'Preset already configured.';

      return { message: responseMessage };
    }

    function guessCategory(app) {
      const host = normalizeHostname(app.url);
      if (host.includes('classroom') || host.includes('canvas') || host.includes('schoology')) return 'Instruction';
      if (host.includes('mail') || host.includes('gmail') || host.includes('outlook')) return 'Communication';
      if (host.includes('drive') || host.includes('docs') || host.includes('dropbox')) return 'Files';
      if (host.includes('blacklink') || host.includes('trust')) return 'Blacklink Suite';
      if (host.includes('alert') || host.includes('incident')) return 'Safety';
      return 'General';
    }

    function toggleFavorite(appId) {
      if (favoriteAppIds.has(appId)) {
        favoriteAppIds.delete(appId);
      } else {
        favoriteAppIds.add(appId);
      }
      persistFavorites();
      renderApps();
      updateStats();
      updateAccountHealth();
    }

    function persistFavorites() {
      try {
        localStorage.setItem(favoriteStorageKey, JSON.stringify([...favoriteAppIds]));
      } catch (error) {
        console.warn('Unable to write favorites to storage', error);
      }
    }

    function syncFavoriteSet() {
      const validIds = new Set(userApps.map(app => app.id));
      favoriteAppIds = new Set([...favoriteAppIds].filter(id => validIds.has(id)));
      persistFavorites();
    }

    function populateCategoryFilter() {
      if (!categoryFilter) return;

      const previous = activeCategory;
      const categories = Array.from(new Set(
        userApps
          .map(app => app.category)
          .filter(Boolean)
      )).sort((a, b) => a.localeCompare(b));

      categoryFilter.innerHTML = '<option value="all">All categories</option>';

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });

      if (previous !== 'all') {
        const match = categories.find(category => category.toLowerCase() === previous.toLowerCase());
        if (match) {
          categoryFilter.value = match;
          activeCategory = match;
        } else {
          categoryFilter.value = 'all';
          activeCategory = 'all';
        }
      } else {
        categoryFilter.value = 'all';
      }
    }

    // Filter Apps
    function filterApps() {
      currentSearchTerm = (searchInput?.value || '').trim().toLowerCase();
      renderApps();
      updateStats();
    }

    // Update Stats
    function updateStats() {
      const totalAppsEl = document.getElementById('totalApps');
      const quickAccessEl = document.getElementById('quickAccess');
      const totalCategoriesEl = document.getElementById('totalCategories');
      const appsChangeEl = document.getElementById('appsChange');

      if (totalAppsEl) {
        totalAppsEl.textContent = userApps.length;
      }

      if (quickAccessEl) {
        quickAccessEl.textContent = favoriteAppIds.size;
      }

      const categories = new Set(
        userApps
          .map(app => app.category)
          .filter(Boolean)
      );

      if (totalCategoriesEl) {
        totalCategoriesEl.textContent = categories.size;
      }

      if (appsChangeEl) {
        if (favoritesOnly) {
          appsChangeEl.textContent = 'Viewing favorites';
        } else if (currentSearchTerm) {
          appsChangeEl.textContent = `Filtered by ‚Äú${currentSearchTerm}‚Äù`;
        } else if (activeCategory !== 'all') {
          appsChangeEl.textContent = `${activeCategory} category`;
        } else if (sortByUsage) {
          appsChangeEl.textContent = 'Sorted by usage';
        } else {
          appsChangeEl.textContent = `${userApps.length} apps total`;
        }
      }
    }

    function updateAccountHealth() {
      if (!healthScoreEl || !healthStatusLabel) return;

      const totalApps = userApps.length;
      const categoryCount = new Set(
        userApps.map(app => (app.category || '').toLowerCase()).filter(Boolean)
      ).size;
      const favoriteCount = favoriteAppIds.size;

      let score = 40;

      if (totalApps >= 5) {
        score += 25;
        setStatusBadge(healthAppsStatus, 'ok', 'Complete');
      } else if (totalApps >= 3) {
        score += 15;
        setStatusBadge(healthAppsStatus, 'warn', 'Almost there');
      } else if (totalApps > 0) {
        score += 5;
        setStatusBadge(healthAppsStatus, 'warn', 'Add more');
      } else {
        setStatusBadge(healthAppsStatus, 'need', 'Pending');
      }

      if (categoryCount >= 3) {
        score += 20;
        setStatusBadge(healthCategoryStatus, 'ok', 'Organized');
      } else if (categoryCount >= 1) {
        score += 10;
        setStatusBadge(healthCategoryStatus, 'warn', 'Needs variety');
      } else {
        setStatusBadge(healthCategoryStatus, 'need', 'No categories');
      }

      if (favoriteCount >= 2) {
        score += 15;
        setStatusBadge(healthFavoriteStatus, 'ok', 'Pinned');
      } else if (favoriteCount === 1) {
        score += 8;
        setStatusBadge(healthFavoriteStatus, 'warn', 'Add one more');
      } else {
        setStatusBadge(healthFavoriteStatus, 'need', 'None selected');
      }

      score = Math.min(100, Math.max(15, score));
      healthScoreEl.textContent = score;

      let statusLabel = 'Needs attention';
      if (score >= 85) {
        statusLabel = 'Launch ready';
      } else if (score >= 60) {
        statusLabel = 'On track';
      }

      healthStatusLabel.textContent = statusLabel;

      if (healthSummary) {
        const summaryParts = [
          `${totalApps} app${totalApps === 1 ? '' : 's'}`,
          `${categoryCount} categor${categoryCount === 1 ? 'y' : 'ies'}`,
          `${favoriteCount} favorite${favoriteCount === 1 ? '' : 's'}`
        ];
        healthSummary.textContent = summaryParts.join(' ‚Ä¢ ');
      }
    }

    function setStatusBadge(element, state, label) {
      if (!element) return;
      element.classList.remove('status-ok', 'status-warn', 'status-need');
      element.classList.add('status');
      const stateClass = state === 'ok' ? 'status-ok' : state === 'warn' ? 'status-warn' : 'status-need';
      element.classList.add(stateClass);
      element.textContent = label;
    }

    function renderActivityFeed() {
      if (!activityFeed) return;

      const events = userApps
        .filter(app => app.lastUsed instanceof Date)
        .sort((a, b) => b.lastUsed.getTime() - a.lastUsed.getTime())
        .slice(0, 5);

      activityFeed.innerHTML = '';

      if (!events.length) {
        const placeholder = document.createElement('li');
        placeholder.className = 'activity-item';
        placeholder.innerHTML = `
          <div class="activity-primary">
            <span class="activity-title">No app usage yet</span>
            <span class="activity-meta">Launch an app to start building your timeline.</span>
          </div>
          <span class="activity-badge">Idle</span>
        `;
        activityFeed.appendChild(placeholder);
        return;
      }

      events.forEach(app => {
        const item = document.createElement('li');
        item.className = 'activity-item';
        const relative = formatRelativeTime(app.lastUsed);
        item.innerHTML = `
          <div class="activity-primary">
            <span class="activity-title">${app.name}</span>
            <span class="activity-meta">${resolveHostname(app.url)} ‚Ä¢ ${relative}</span>
          </div>
          <span class="activity-badge">${app.category || 'App'}</span>
        `;
        activityFeed.appendChild(item);
      });
    }

    function formatRelativeTime(date) {
      if (!(date instanceof Date)) {
        return 'Recently';
      }
      const diffMs = Date.now() - date.getTime();
      const minutes = Math.round(diffMs / 60000);
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes} min${minutes === 1 ? '' : 's'} ago`;
      const hours = Math.round(minutes / 60);
      if (hours < 24) return `${hours} hr${hours === 1 ? '' : 's'} ago`;
      const days = Math.round(hours / 24);
      if (days < 7) return `${days} day${days === 1 ? '' : 's'} ago`;
      const weeks = Math.round(days / 7);
      if (weeks < 4) return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
      const months = Math.round(days / 30);
      if (months < 12) return `${months} mo${months === 1 ? '' : 's'} ago`;
      const years = Math.round(days / 365);
      return `${years} yr${years === 1 ? '' : 's'} ago`;
    }

    function updateTierElements(tier, tokens) {
      subscriptionTier = normalizeTier(tier);

      if (tokens) {
        aeroTokens = tokens;
      }

      const tierBadge = document.getElementById('tierBadge');
      if (tierBadge) {
        tierBadge.classList.remove('ultra-plus');
        if (subscriptionTier === 'ULTRA') {
          tierBadge.textContent = 'ULTRA';
          tierBadge.style.display = 'inline-block';
        } else if (subscriptionTier === 'ULTRA_PLUS') {
          tierBadge.textContent = 'ULTRA+';
          tierBadge.classList.add('ultra-plus');
          tierBadge.style.display = 'inline-block';
        } else {
          tierBadge.style.display = 'none';
        }
      }

      window.Navbar?.setUser({ tier: subscriptionTier, email: currentUser?.email, isAdmin });

      updateAeroBadge();

      // Show/hide analytics panel based on tier
      const analyticsPanel = document.getElementById('analyticsPanel');
      if (analyticsPanel) {
        analyticsPanel.style.display = (subscriptionTier === 'ULTRA' || subscriptionTier === 'ULTRA_PLUS') ? 'block' : 'none';
        if (analyticsPanel.style.display === 'block') {
          refreshAnalytics();
        }
      }

      // Handle hash navigation for features
      handleHashNavigation();
    }

    function updateAeroBadge() {
      const aeroTokensBadge = document.getElementById('aeroTokensBadge');
      const aeroBalance = document.getElementById('aeroBalance');
      if (!aeroTokensBadge || !aeroBalance) return;

      if (!aeroTokens || subscriptionTier === 'FREE') {
        aeroTokensBadge.style.display = 'none';
        return;
      }

      const remaining = typeof aeroTokens === 'number'
        ? aeroTokens
        : Number(aeroTokens.remaining || aeroTokens.balance || 0);
      aeroBalance.textContent = formatCurrency(remaining);
      aeroTokensBadge.style.display = remaining > 0 ? 'flex' : 'none';
    }

    function renderAdminUtilities() {
      if (!adminUtilityGrid || !adminControlCard) return;

      const utilities = adminUtilityCatalog || [];
      if (!isAdmin || utilities.length === 0) {
        adminControlCard.style.display = 'none';
        return;
      }

      adminControlCard.style.display = 'block';

      // Load admin stats when showing panel
      loadAdminStats();

      adminUtilityGrid.innerHTML = utilities.map(utility => `
        <div class="admin-action-card" data-action="${utility.action || utility.id}">
          <div class="admin-action-icon" style="background: ${hexToRgba(utility.color, 0.15)}; color: ${utility.color};">
            ${utility.icon || 'üõ†Ô∏è'}
          </div>
          <div class="admin-action-name">${utility.name}</div>
          <div class="admin-action-description">${utility.description}</div>
        </div>
      `).join('');
    }

    function formatCurrency(amount) {
      if (typeof amount !== 'number' || Number.isNaN(amount)) {
        return '$0';
      }
      try {
        return currencyFormatter.format(Math.max(amount, 0));
      } catch {
        return `$${Math.max(0, Math.round(amount))}`;
      }
    }

    function hexToRgba(hex, alpha = 1) {
      if (!hex) return `rgba(99, 102, 241, ${alpha})`;
      const cleaned = hex.replace('#', '');
      if (cleaned.length !== 6) return `rgba(99, 102, 241, ${alpha})`;
      const number = parseInt(cleaned, 16);
      const r = (number >> 16) & 255;
      const g = (number >> 8) & 255;
      const b = number & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function setFocusMode(isEnabled) {
      if (isEnabled) {
        document.body.classList.add('focus-mode');
      } else {
        document.body.classList.remove('focus-mode');
      }
      focusModeToggle?.classList.toggle('active', isEnabled);
      focusModeToggle?.setAttribute('aria-pressed', String(isEnabled));
      if (focusIndicator) {
        focusIndicator.textContent = isEnabled ? '‚úÖ Focus mode on' : 'üéØ Focus mode';
      }
      try {
        localStorage.setItem(focusModeStorageKey, String(isEnabled));
      } catch (error) {
        console.warn('Unable to persist focus mode preference', error);
      }
    }

    // Open Add App Modal
    function openAddAppModal() {
      editingAppId = null;
      document.getElementById('modalTitle').textContent = 'Add Application';
      document.getElementById('appForm').reset();
      document.getElementById('appId').value = '';
      document.getElementById('appColor').value = 'purple';

      // Reset color selection
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === 'purple') {
          opt.classList.add('selected');
        }
      });

      document.getElementById('appModal').classList.add('active');
    }

    // Close Modal
    function closeAppModal() {
      document.getElementById('appModal').classList.remove('active');
      editingAppId = null;
    }

    function closeAdminModal() {
      document.getElementById('adminModal').classList.remove('active');
    }

    // Preset Selector Functions
    async function openPresetSelector() {
      const modal = document.getElementById('presetModal');
      const grid = document.getElementById('presetGrid');

      if (!modal || !grid) return;

      // Show modal
      modal.classList.add('active');

      // Load available presets
      const presets = window.QuickLaunchPresets.getAvailablePresets(isAdmin);

      // Render preset cards
      grid.innerHTML = presets.map(preset => `
        <div class="card" style="cursor: pointer; transition: var(--transition);" onclick="selectPreset('${preset.id}')">
          <div style="font-size: 3rem; text-align: center; margin-bottom: 1rem;">
            ${preset.icon}
          </div>
          <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; text-align: center;">
            ${preset.name}
          </h3>
          <p style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; margin-bottom: 1rem;">
            ${preset.description}
          </p>
          ${preset.requiresAdmin ? '<span class="badge badge-danger" style="display: block; text-align: center;">Admin Only</span>' : ''}
        </div>
      `).join('');

      // Track analytics
      if (window.BlacklinkAnalytics) {
        BlacklinkAnalytics.trackEvent('preset_selector_opened', {
          availablePresets: presets.length
        });
      }
    }

    function closePresetSelector() {
      document.getElementById('presetModal').classList.remove('active');
    }

    // Theme Builder Functions
    function openThemeBuilder() {
      if (subscriptionTier !== 'ULTRA_PLUS') {
        showToast('Custom theme builder is an ULTRA+ exclusive feature', 'info');
        return;
      }

      const modal = document.getElementById('themeBuilderModal');
      if (!modal) {
        console.error('MODAL NOT FOUND!');
        alert('MODAL ELEMENT NOT FOUND!');
        return;
      }

      console.log('Opening modal...');
      modal.style.display = 'flex';
      setupThemePreview();

      // Track analytics
      if (window.BlacklinkAnalytics) {
        BlacklinkAnalytics.trackEvent('theme_builder_opened', { tier: subscriptionTier });
      }
    }

    function closeThemeBuilder() {
      const modal = document.getElementById('themeBuilderModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Global click handler for modal overlays
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
      }
    });

    function setupThemePreview() {
      const inputs = ['themeBgColor', 'themeTextColor', 'themePrimaryColor', 'themeCardBg', 'themeBorderColor'];
      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateThemePreview);
        }
      });
      updateThemePreview();
    }

    function updateThemePreview() {
      const preview = document.getElementById('themePreview');
      const card = preview?.querySelector('div');
      const button = card?.querySelector('button');

      const bgColor = document.getElementById('themeBgColor')?.value || '#0f172a';
      const textColor = document.getElementById('themeTextColor')?.value || '#f1f5f9';
      const primaryColor = document.getElementById('themePrimaryColor')?.value || '#6366f1';
      const cardBg = document.getElementById('themeCardBg')?.value || '#1e293b';
      const borderColor = document.getElementById('themeBorderColor')?.value || '#334155';

      if (preview) {
        preview.style.background = bgColor;
        preview.style.borderColor = borderColor;
      }

      if (card) {
        card.style.background = cardBg;
        card.style.borderColor = borderColor;
        card.querySelector('div').style.color = textColor;
        card.querySelectorAll('div')[1].style.color = textColor + 'b3';
      }

      if (button) {
        button.style.background = primaryColor;
      }
    }

    async function saveCustomTheme() {
      const themeName = document.getElementById('themeNameInput')?.value || 'Custom Theme';

      const customTheme = {
        name: themeName,
        id: `custom-${Date.now()}`,
        colors: {
          bg: document.getElementById('themeBgColor')?.value,
          text: document.getElementById('themeTextColor')?.value,
          primary: document.getElementById('themePrimaryColor')?.value,
          cardBg: document.getElementById('themeCardBg')?.value,
          border: document.getElementById('themeBorderColor')?.value
        },
        createdAt: new Date().toISOString()
      };

      try {
        await db.collection('users').doc(currentUser.uid).collection('customThemes').add(customTheme);
        showToast(`Theme "${themeName}" saved successfully!`, 'success');
        closeThemeBuilder();

        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('custom_theme_saved', { themeName });
        }
      } catch (error) {
        console.error('Error saving theme:', error);
        showToast('Failed to save theme', 'error');
      }
    }

    // Analytics Functions
    async function refreshAnalytics() {
      if (subscriptionTier === 'FREE') {
        showToast('Analytics is an ULTRA feature', 'info');
        return;
      }

      try {
        // Calculate analytics from user apps
        const totalLaunches = userApps.reduce((sum, app) => sum + (app.usage || 0), 0);
        const activeApps = userApps.filter(app => (app.usage || 0) > 0).length;
        const avgDaily = Math.round(totalLaunches / 7); // Last 7 days estimate

        // Find top app
        const topApp = userApps.reduce((top, app) =>
          (app.usage || 0) > (top.usage || 0) ? app : top
        , { name: '-', usage: 0 });

        // Update UI
        document.getElementById('totalLaunches').textContent = totalLaunches;
        document.getElementById('activeApps').textContent = activeApps;
        document.getElementById('avgDaily').textContent = avgDaily;
        document.getElementById('topApp').textContent = topApp.name;

        showToast('Analytics refreshed', 'success');

        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('analytics_refreshed', { totalLaunches, activeApps });
        }
      } catch (error) {
        console.error('Error refreshing analytics:', error);
        showToast('Failed to refresh analytics', 'error');
      }
    }

    // Admin Panel Functions
    async function loadAdminStats() {
      if (!isAdmin) return;

      try {
        // Get total users count
        const usersSnapshot = await db.collection('users').get();
        const totalUsers = usersSnapshot.size;

        // Count ULTRA users
        let ultraUsers = 0;
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          const tier = data.tier || 'FREE';
          if (tier.includes('ULTRA') || tier.includes('Employee') || tier.includes('District')) {
            ultraUsers++;
          }
        });

        // Count active today (simplified - last login within 24hrs)
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        let activeToday = 0;
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          const lastLogin = data.lastLogin?.toDate?.() || data.lastLogin;
          if (lastLogin && lastLogin > oneDayAgo) {
            activeToday++;
          }
        });

        // Update UI
        document.getElementById('adminTotalUsers').textContent = totalUsers;
        document.getElementById('adminUltraUsers').textContent = ultraUsers;
        document.getElementById('adminActiveToday').textContent = activeToday;

        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('admin_stats_loaded', { totalUsers, ultraUsers, activeToday });
        }
      } catch (error) {
        console.error('Error loading admin stats:', error);
        document.getElementById('adminTotalUsers').textContent = 'Error';
        document.getElementById('adminUltraUsers').textContent = 'Error';
        document.getElementById('adminActiveToday').textContent = 'Error';
      }
    }

    // Hash Navigation Handler
    function handleHashNavigation() {
      const hash = window.location.hash.slice(1);

      switch (hash) {
        case 'analytics':
          if (subscriptionTier === 'ULTRA' || subscriptionTier === 'ULTRA_PLUS') {
            document.getElementById('analyticsPanel')?.scrollIntoView({ behavior: 'smooth' });
          } else {
            showToast('Analytics is an ULTRA feature. Upgrade to access!', 'info');
          }
          break;
        case 'theme-builder':
          openThemeBuilder();
          break;
        case 'automations':
          document.querySelector('[data-automation]')?.scrollIntoView({ behavior: 'smooth' });
          break;
      }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleHashNavigation);

    async function selectPreset(presetId) {
      try {
        // Show loading toast
        BlacklinkUtils.showToast('Loading preset...', 'info');

        // Load preset data
        const presetData = await window.QuickLaunchPresets.loadPreset(presetId);

        // Apply preset with current user's tier
        const config = window.QuickLaunchPresets.applyPreset(presetData, {
          filterByTier: subscriptionTier,
          filterByAdmin: isAdmin
        });

        // Save preset preference
        try {
          await window.QuickLaunchPresets.savePresetPreference(presetId, db, currentUser.uid);
        } catch (error) {
          console.warn('Could not save preset preference:', error);
        }

        // Apply apps to QuickLaunch
        userApps = config.apps.map((app, index) => ({
          ...app,
          favorite: app.pinned || false,
          usageCount: 0,
          lastUsed: null,
          addedAt: new Date().toISOString()
        }));

        // Save to Firestore
        await saveAppsToFirestore();

        // Render apps
        renderApps();
        updateStats();

        // Close modal
        closePresetSelector();

        // Show success message
        BlacklinkUtils.showToast(`${presetData.name} preset applied successfully!`, 'success');

        // Track analytics
        if (window.BlacklinkAnalytics) {
          BlacklinkAnalytics.trackEvent('preset_applied', {
            presetId: presetId,
            presetName: presetData.name,
            appCount: config.apps.length
          });
        }
      } catch (error) {
        console.error('Error applying preset:', error);
        BlacklinkUtils.showToast('Failed to load preset', 'danger');
      }
    }

    function createCustomPreset() {
      BlacklinkUtils.showToast('Custom preset creator coming soon!', 'info');
      closePresetSelector();

      // Track analytics
      if (window.BlacklinkAnalytics) {
        BlacklinkAnalytics.trackEvent('custom_preset_clicked');
      }
    }

    function handleAdminUtilityAction(action, itemId) {
      const adminModalTitle = document.getElementById('adminModalTitle');
      const adminModalBody = document.getElementById('adminModalBody');
      const adminModal = document.getElementById('adminModal');

      if (!adminModal || !adminModalTitle || !adminModalBody) return;

      // Set modal title based on action
      const titles = {
        'openAdminInsights': 'Admin Console',
        'openReleasePlanner': 'Release Manager',
        'openSupportQueue': 'Support Queue'
      };

      adminModalTitle.textContent = titles[action] || 'Admin Tool';

      // Set modal content based on action
      let content = '';
      switch (action) {
        case 'openAdminInsights':
          content = `
            <div style="padding: 1rem;">
              <p style="color: var(--text-secondary); margin-bottom: 1rem;">Internal console for auditing users, subscriptions, and ULTRA allocations.</p>
              <p style="color: var(--text-muted); font-size: 0.9rem;">This feature is under development.</p>
            </div>
          `;
          break;
        case 'openReleasePlanner':
          content = `
            <div style="padding: 1rem;">
              <p style="color: var(--text-secondary); margin-bottom: 1rem;">Schedule feature rollouts and manage staged deployment tracks without leaving Accounts.</p>
              <p style="color: var(--text-muted); font-size: 0.9rem;">This feature is under development.</p>
            </div>
          `;
          break;
        case 'openSupportQueue':
          content = `
            <div style="padding: 1rem;">
              <p style="color: var(--text-secondary); margin-bottom: 1rem;">Prioritize and resolve incoming ULTRA support tickets from Aero Desk.</p>
              <p style="color: var(--text-muted); font-size: 0.9rem;">This feature is under development.</p>
            </div>
          `;
          break;
        default:
          content = `
            <div style="padding: 1rem;">
              <p style="color: var(--text-muted);">Admin utility not yet implemented.</p>
            </div>
          `;
      }

      adminModalBody.innerHTML = content;
      adminModal.classList.add('active');
    }

    // Edit App
    async function editApp(appId) {
      const app = userApps.find(a => a.id === appId);
      if (!app) return;

      editingAppId = appId;
      document.getElementById('modalTitle').textContent = 'Edit Application';
      document.getElementById('appId').value = appId;
      document.getElementById('appName').value = app.name;
      document.getElementById('appUrl').value = app.url;
      document.getElementById('appCategory').value = app.category || '';
      document.getElementById('appColor').value = app.color || 'purple';

      // Update color selection
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === (app.color || 'purple')) {
          opt.classList.add('selected');
        }
      });

      document.getElementById('appModal').classList.add('active');
    }

    // Save App
    async function saveApp(event) {
      event.preventDefault();

      const appData = {
        name: document.getElementById('appName').value.trim(),
        url: document.getElementById('appUrl').value.trim(),
        category: document.getElementById('appCategory').value.trim(),
        color: document.getElementById('appColor').value,
        userId: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        const collectionRef = quickLaunchCollection();
        if (editingAppId) {
          // Update existing app
          await collectionRef.doc(editingAppId).update(appData);
          showToast('App updated successfully', 'success');
        } else {
          // Create new app
          appData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          appData.usage = 0;
          await collectionRef.add(appData);
          showToast('App added successfully', 'success');
        }

        closeAppModal();
        await loadApps();
      } catch (error) {
        console.error('Error saving app:', error);
        showToast('Error saving app', 'error');
      }
    }

    // Delete App
    async function deleteApp(appId) {
      if (!confirm('Are you sure you want to delete this app?')) return;

      try {
        await quickLaunchCollection().doc(appId).delete();
        showToast('App deleted successfully', 'success');
        await loadApps();
      } catch (error) {
        console.error('Error deleting app:', error);
        showToast('Error deleting app', 'error');
      }
    }

    // Increment App Usage
    async function incrementAppUsage(appId) {
      try {
        await quickLaunchCollection().doc(appId).update({
          usage: firebase.firestore.FieldValue.increment(1),
          lastUsed: firebase.firestore.FieldValue.serverTimestamp()
        });

        const targetApp = userApps.find(app => app.id === appId);
        if (targetApp) {
          targetApp.usage = (targetApp.usage || 0) + 1;
          targetApp.lastUsed = new Date();
          renderApps();
          updateStats();
          updateAccountHealth();
          renderActivityFeed();
        }
      } catch (error) {
        console.error('Error updating usage:', error);
      }
    }

    // Color Picker
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        document.getElementById('appColor').value = option.dataset.color;
      });
    });

    adminModal?.addEventListener('click', (event) => {
      if (event.target === adminModal) {
        closeAdminModal();
      }
    });
    // Toast Notifications
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
        <div class="toast-message">${message}</div>
      `;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (adminModal?.classList.contains('active')) {
          closeAdminModal();
        } else {
          closeAppModal();
        }
      }
    });

    async function seedPreconfiguredApps() {
      if (!currentUser) {
        return false;
      }

      try {
        const collectionRef = quickLaunchCollection();
        const appsSnapshot = await collectionRef.get();

        const existingHosts = new Set(
          appsSnapshot.docs
            .map(doc => normalizeHostname(doc.data().url))
            .filter(Boolean)
        );

        const appsToAdd = preconfiguredApps.filter(app => !existingHosts.has(normalizeHostname(app.url)));

        if (!appsToAdd.length) {
          return false;
        }

        const batch = db.batch();

        appsToAdd.forEach(app => {
          const ref = collectionRef.doc();
          batch.set(ref, {
            ...app,
            userId: currentUser.uid,
            usage: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await batch.commit();
        return true;
      } catch (error) {
        throw error;
      }
    }
  </script>
</body>

</html>
